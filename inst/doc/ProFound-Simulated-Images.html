<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Aaron Robotham" />

<meta name="date" content="2018-03-02" />

<title>ProFound: Testing on Simulated Images</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">ProFound: Testing on Simulated Images</h1>
<h4 class="author"><em>Aaron Robotham</em></h4>
<h4 class="date"><em>2018-03-02</em></h4>



<p>Get the latest version of <strong>ProFound</strong> and <strong>ProFit</strong>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(devtools)
<span class="kw">install_github</span>(<span class="st">'asgr/ProFound'</span>)
<span class="kw">install_github</span>(<span class="st">'ICRAR/ProFit'</span>)</code></pre></div>
<p>First of all we load <strong>ProFit</strong> and <strong>ProFound</strong>. We also need to use <strong>LaplacesDemon</strong> because it gives us the Pareto (power-law) distribution that we will use to realistically sample our magnitude ranges later.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ProFound)
<span class="kw">library</span>(ProFit)
<span class="kw">library</span>(LaplacesDemon)</code></pre></div>
<div id="making-simulated-data" class="section level2">
<h2>Making Simulated Data</h2>
<p>Next we generate a random image with 200 stars and 200 extended sources. The value used roughly correspoond to the source densities and magnitude distributions you might expect to find in a Z-band VIKING frame (this was used to derive the image statistics).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">666</span>)

ExamplePSF=<span class="kw">profitMakeGaussianPSF</span>(<span class="dt">fwhm=</span><span class="dv">5</span>)
ExamplePSF=ExamplePSF/<span class="kw">sum</span>(ExamplePSF)

Ngal=<span class="dv">200</span>
Nstar=<span class="dv">200</span>

model_test=<span class="kw">list</span>(
    <span class="dt">sersic=</span><span class="kw">list</span>(
        <span class="dt">xcen=</span><span class="kw">runif</span>(Ngal,<span class="dv">0</span>,<span class="dv">1000</span>),
        <span class="dt">ycen=</span><span class="kw">runif</span>(Ngal,<span class="dv">0</span>,<span class="dv">1000</span>),
        <span class="dt">mag=</span><span class="dv">24</span>-<span class="kw">rpareto</span>(Ngal,<span class="dv">2</span>),
        <span class="dt">re=</span><span class="kw">rpois</span>(Ngal,<span class="dv">5</span>)+<span class="kw">runif</span>(Ngal),
        <span class="dt">nser=</span><span class="kw">runif</span>(Ngal,<span class="dv">1</span>,<span class="dv">4</span>),
        <span class="dt">ang=</span><span class="kw">runif</span>(Ngal,<span class="dv">0</span>,<span class="dv">180</span>),
        <span class="dt">axrat=</span><span class="kw">runif</span>(Ngal,<span class="fl">0.3</span>,<span class="dv">1</span>),
        <span class="dt">box=</span><span class="kw">runif</span>(Ngal,-<span class="fl">0.3</span>,<span class="fl">0.3</span>)
    ),
    <span class="dt">pointsource=</span><span class="kw">list</span>(
        <span class="dt">xcen=</span><span class="kw">runif</span>(Nstar,<span class="dv">0</span>,<span class="dv">1000</span>),
        <span class="dt">ycen=</span><span class="kw">runif</span>(Nstar,<span class="dv">0</span>,<span class="dv">1000</span>),
        <span class="dt">mag=</span><span class="dv">24</span>-<span class="kw">rpareto</span>(Nstar,<span class="fl">1.5</span>)
    )
)

model_test$sersic$mag[model_test$sersic$mag&lt;<span class="dv">15</span>]=<span class="kw">runif</span>(<span class="kw">length</span>(<span class="kw">which</span>(model_test$sersic$mag&lt;<span class="dv">15</span>)),<span class="dv">15</span>,<span class="dv">22</span>)
model_test$pointsource$mag[model_test$pointsource$mag&lt;<span class="dv">15</span>]=<span class="kw">runif</span>(<span class="kw">length</span>(<span class="kw">which</span>(model_test$pointsource$mag&lt;<span class="dv">15</span>)),<span class="dv">15</span>,<span class="dv">22</span>)

im_test&lt;-<span class="kw">profitMakeModel</span>(<span class="dt">modellist=</span>model_test, <span class="dt">psf=</span>ExamplePSF, <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">1000</span>,<span class="dv">1000</span>), <span class="dt">magzero =</span> <span class="dv">30</span>)$z</code></pre></div>
<p>We can take a peak at the raw model before adding on noise and sky etc:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">magimage</span>(im_test)</code></pre></div>
<p>Next we add typical VIKING object shot-noise and sky noise:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">im_test=im_test+<span class="kw">rnorm</span>(<span class="fl">1e6</span>,<span class="dt">sd=</span><span class="kw">sqrt</span>(im_test))
im_test=im_test+<span class="kw">rnorm</span>(<span class="fl">1e6</span>,<span class="dt">sd=</span><span class="dv">10</span>)</code></pre></div>
<p>And we now add a random slightly complex sky:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">666</span>)

model_sky=<span class="kw">list</span>(
    <span class="dt">pointsource=</span><span class="kw">list</span>(
        <span class="dt">xcen=</span><span class="kw">runif</span>(<span class="dv">500</span>,<span class="dv">0</span>,<span class="dv">1000</span>),
        <span class="dt">ycen=</span><span class="kw">runif</span>(<span class="dv">500</span>,<span class="dv">0</span>,<span class="dv">1000</span>),
        <span class="dt">mag=</span><span class="dv">20</span>-<span class="kw">rpareto</span>(<span class="dv">500</span>,<span class="fl">1.5</span>)
    )
)

im_sky&lt;-<span class="kw">profitMakeModel</span>(<span class="dt">modellist=</span>model_sky, <span class="dt">psf=</span>ExamplePSF, <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">1000</span>,<span class="dv">1000</span>), <span class="dt">magzero =</span> <span class="dv">30</span>)$z
im_sky=im_sky+<span class="kw">rnorm</span>(<span class="fl">1e6</span>,<span class="dv">2</span>,<span class="dv">10</span>)
grid_sky=<span class="kw">profoundMakeSkyGrid</span>(im_sky, <span class="dt">type=</span><span class="st">'bicubic'</span>)$sky

im_test=im_test+grid_sky</code></pre></div>
<p>Let’s have a look:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">magimage</span>(im_test)

<span class="kw">magimage</span>(im_test)
<span class="kw">points</span>(model_test$sersic$xcen, model_test$sersic$ycen, <span class="dt">col=</span><span class="st">'yellow'</span>)
<span class="kw">points</span>(model_test$pointsource$xcen, model_test$pointsource$ycen, <span class="dt">col=</span><span class="st">'green'</span>)</code></pre></div>
</div>
<div id="deep-extraction-with-profound" class="section level2">
<h2>Deep Extraction With ProFound</h2>
<p>Now we run ProFound with fairly standard settings (note we set the VIRCAM pixel scale):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">magimage</span>(im_test)

pro_test=<span class="kw">profoundProFound</span>(im_test, <span class="dt">magzero=</span><span class="dv">30</span>, <span class="dt">verbose=</span><span class="ot">TRUE</span>, <span class="dt">plot=</span><span class="ot">TRUE</span>, <span class="dt">boundstats=</span><span class="ot">TRUE</span>, <span class="dt">pixscale=</span><span class="fl">0.34</span>, <span class="dt">tolerance=</span><span class="dv">2</span>)
<span class="kw">points</span>(model_test$sersic$xcen, model_test$sersic$ycen, <span class="dt">col=</span><span class="st">'yellow'</span>)
<span class="kw">points</span>(model_test$pointsource$xcen, model_test$pointsource$ycen, <span class="dt">col=</span><span class="st">'green'</span>)</code></pre></div>
<p>We can match back to our initial catalogue using coordmatch in <strong>celestial</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">testmatch_gals=<span class="kw">coordmatch</span>(<span class="kw">cbind</span>(model_test$sersic$xcen,model_test$sersic$ycen)/<span class="dv">3600</span>, pro_test$segstats[,<span class="kw">c</span>(<span class="st">&quot;xcen&quot;</span>,<span class="st">&quot;ycen&quot;</span>)]/<span class="dv">3600</span>,<span class="dv">5</span>)

testmatch_stars=<span class="kw">coordmatch</span>(<span class="kw">cbind</span>(model_test$pointsource$xcen,model_test$pointsource$ycen)/<span class="dv">3600</span>,pro_test$segstats[,<span class="kw">c</span>(<span class="st">&quot;xcen&quot;</span>,<span class="st">&quot;ycen&quot;</span>)]/<span class="dv">3600</span>,<span class="dv">5</span>)</code></pre></div>
<p>And plot the difference in estimated magnitude for the point sources (red) and extended sources (blue):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">magplot</span>(model_test$sersic$mag[testmatch_gals$bestmatch$refID], model_test$sersic$mag[testmatch_gals$bestmatch$refID]-pro_test$segstats[testmatch_gals$bestmatch$compareID,<span class="st">'mag'</span>], <span class="dt">grid=</span><span class="ot">TRUE</span>, <span class="dt">ylim=</span><span class="kw">c</span>(-<span class="dv">1</span>,<span class="dv">1</span>), <span class="dt">col=</span><span class="st">'blue'</span>)
<span class="kw">points</span>(pro_test$segstats$mag, pro_test$segstats$mag_err, <span class="dt">pch=</span><span class="st">'.'</span>)
<span class="kw">points</span>(pro_test$segstats$mag, -pro_test$segstats$mag_err, <span class="dt">pch=</span><span class="st">'.'</span>)

<span class="kw">points</span>(model_test$pointsource$mag[testmatch_stars$bestmatch$refID], model_test$pointsource$mag[testmatch_stars$bestmatch$refID]-pro_test$segstats[testmatch_stars$bestmatch$compareID,<span class="st">'mag'</span>],<span class="dt">col=</span><span class="st">'red'</span>)</code></pre></div>
<p>We can check how good our sky estimates were too:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">magplot</span>(<span class="kw">density</span>(pro_test$sky))
<span class="kw">lines</span>(<span class="kw">density</span>(grid_sky), <span class="dt">col=</span><span class="st">'red'</span>)

skyRMSerror=<span class="kw">sd</span>(pro_test$skyRMS)
<span class="kw">maghist</span>(pro_test$skyRMS, <span class="dt">breaks=</span><span class="dv">100</span>)
<span class="kw">abline</span>(<span class="dt">v=</span><span class="kw">c</span>(<span class="dv">10</span>-skyRMSerror,<span class="dv">10</span>,<span class="dv">10</span>+skyRMSerror), <span class="dt">lty=</span><span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="dt">col=</span><span class="st">'red'</span>)</code></pre></div>
<p>You can see there is a slight bias to a positive sky measurement- this is caused by the background of very faint currently undetected sources</p>
<p>Next we can make a new image where the detected objects are replaced with noise representing out estimated measurements:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">im_test_sub=im_test
im_test_sub[pro_test$objects_redo==<span class="dv">1</span>]=<span class="kw">rnorm</span>(<span class="kw">length</span>(<span class="kw">which</span>(pro_test$objects_redo==<span class="dv">1</span>)), <span class="dt">mean=</span>pro_test$sky[pro_test$objects_redo==<span class="dv">1</span>], <span class="dt">sd=</span>pro_test$skyRMS[pro_test$objects_redo==<span class="dv">1</span>])</code></pre></div>
<p>And we can plot this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">magimage</span>(pro_test$objects_redo)
<span class="kw">points</span>(model_test$sersic$xcen, model_test$sersic$ycen, <span class="dt">col=</span><span class="st">'yellow'</span>)
<span class="kw">points</span>(model_test$pointsource$xcen, model_test$pointsource$ycen, <span class="dt">col=</span><span class="st">'green'</span>)

<span class="kw">magimage</span>(im_test_sub)

<span class="kw">magimage</span>(im_test_sub)
<span class="kw">points</span>(model_test$sersic$xcen, model_test$sersic$ycen, <span class="dt">col=</span><span class="st">'yellow'</span>)
<span class="kw">points</span>(model_test$pointsource$xcen, model_test$pointsource$ycen, <span class="dt">col=</span><span class="st">'green'</span>)

<span class="kw">magimage</span>(<span class="kw">profoundImBlur</span>(im_test_sub,<span class="dv">5</span>))

<span class="kw">magimage</span>(<span class="kw">profoundImBlur</span>(im_test_sub,<span class="dv">5</span>))
<span class="kw">points</span>(model_test$sersic$xcen, model_test$sersic$ycen, <span class="dt">col=</span><span class="st">'yellow'</span>)
<span class="kw">points</span>(model_test$pointsource$xcen, model_test$pointsource$ycen, <span class="dt">col=</span><span class="st">'green'</span>)</code></pre></div>
<p>The next step is to run <strong>ProFound</strong> again but pushing down to detect fainter objects. We use the sky and sky-RMS from the first run, and then mask out region that have known high surface brightness objects.</p>
<p>The important parameter now is the skycut. somewhere between 0.1 and 0.2 recovers the very faint objecst we have left- too low and we see a lot of false-positive contamination, too high and our true-positive rate drops. Setting it to 0.15 appears to be about the sweet spot (this would need testing on different depth data with realistic source distributions etc).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">magimage</span>(im_test)

pro_test_sub=<span class="kw">profoundProFound</span>(<span class="dt">image=</span>im_test_sub, <span class="dt">mask=</span>pro_test$objects, <span class="dt">sky=</span>pro_test$sky, <span class="dt">skyRMS=</span>pro_test$skyRMS, <span class="dt">magzero=</span><span class="dv">30</span>, <span class="dt">skycut=</span><span class="fl">0.15</span>, <span class="dt">pixcut=</span><span class="dv">3</span>, <span class="dt">verbose=</span><span class="ot">TRUE</span>, <span class="dt">plot=</span><span class="ot">TRUE</span>, <span class="dt">boundstats=</span><span class="ot">TRUE</span>, <span class="dt">pixscale=</span><span class="fl">0.34</span>, <span class="dt">tolerance=</span><span class="dv">2</span>, <span class="dt">sigma=</span><span class="dv">5</span>)
<span class="kw">points</span>(model_test$sersic$xcen, model_test$sersic$ycen, <span class="dt">col=</span><span class="st">'yellow'</span>,<span class="dt">cex=</span><span class="fl">0.5</span>)
<span class="kw">points</span>(model_test$pointsource$xcen, model_test$pointsource$ycen, <span class="dt">col=</span><span class="st">'green'</span>,<span class="dt">cex=</span><span class="fl">0.5</span>)</code></pre></div>
<p>It is worth experimenting with the above, but it should be clear that with a few steps of detection of masking, very low surface brightness obects can be extracted with some confidence. To fully parameterise these faint objects a proper galaxy profile should be made using <strong>ProFit</strong>.</p>
<p>Now in practice for very faint extraction you would never use objects on the image edges since you will never have an ideal estimate of the sky. We can cut our catalogue down for this effect:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">faintcat=pro_test_sub$segstats[pro_test_sub$segstats$Nborder==<span class="dv">0</span>,]</code></pre></div>
<p>Now we can add our two catalogues (our bright pass and faint pass) back together and match back. Ntoe that the segIDs will be repeated (so be careful using these when catalogues have been combined), but the unique IDs will be unique.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">finalcat=<span class="kw">rbind</span>(pro_test$segstats, faintcat)
<span class="kw">dim</span>(finalcat)</code></pre></div>
<p>The final catalogue is 402 rows, which is encouraging since we created 400 objects.</p>
<p>We can match this fainter run back against the original catalogue:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">testmatch_gals_fin=<span class="kw">coordmatch</span>(<span class="kw">cbind</span>(model_test$sersic$xcen,model_test$sersic$ycen)/<span class="dv">3600</span>,  finalcat[,<span class="kw">c</span>(<span class="st">&quot;xcen&quot;</span>,<span class="st">&quot;ycen&quot;</span>)]/<span class="dv">3600</span>,<span class="dv">5</span>)

testmatch_stars_fin=<span class="kw">coordmatch</span>(<span class="kw">cbind</span>(model_test$pointsource$xcen,model_test$pointsource$ycen)/<span class="dv">3600</span>, finalcat[,<span class="kw">c</span>(<span class="st">&quot;xcen&quot;</span>,<span class="st">&quot;ycen&quot;</span>)]/<span class="dv">3600</span>,<span class="dv">5</span>)</code></pre></div>
<p>So some final stats. False-positive=FP (this is bad) and true-positive=TP (this is good).</p>
<p>Galaxy TP = length(testmatch_gals_fin<span class="math inline">\(bestmatch[,1])/Ngal Stars TP = length(testmatch_stars_fin\)</span>bestmatch[,1])/Nstar Total TP = (length(testmatch_gals_fin<span class="math inline">\(bestmatch[,1])+length(testmatch_stars_fin\)</span>bestmatch[,1]))/(Ngal+Nstar)</p>
<p>Total FP = (dim(finalcat)[1]-length(testmatch_gals_fin<span class="math inline">\(bestmatch[,1])-length(testmatch_stars_fin\)</span>bestmatch[,1]))/(Ngal+Nstar)</p>
<p>So we recover 73% of true galaxies, 97% of true stars (i.e. 85% of all true sources) and suffer 17% false positives. This suggests we cannot push much harder on the detection side since most of the new objects will be FALSE (since TP ~ 1-FP, and it will only get harder from here).</p>
<p>We can make a final image with all structure removed, sky subtracted and divided through by the RMS.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">im_test_fin=im_test_sub-pro_test_sub$sky
im_test_fin[pro_test_sub$objects_redo==<span class="dv">1</span>]=<span class="kw">rnorm</span>(<span class="kw">length</span>(<span class="kw">which</span>(pro_test_sub$objects_redo==<span class="dv">1</span>)), <span class="dt">mean=</span><span class="dv">0</span>, <span class="dt">sd=</span>pro_test_sub$skyRMS[pro_test_sub$objects_redo==<span class="dv">1</span>])
im_test_fin=im_test_fin/pro_test_sub$skyRMS</code></pre></div>
<p>To see whether we have removed (or subtracted out in the case of the sky) all structure we can look at pixel-to-pixel correlation and the 2D FFT (both returned as part of the <strong>profoundPixelCorrelation</strong> function):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">magimage</span>(<span class="kw">profoundPixelCorrelation</span>(im_test, <span class="dt">skyRMS=</span><span class="dv">10</span>, <span class="dt">plot=</span><span class="ot">TRUE</span>)$fft, <span class="dt">xlab=</span><span class="st">'kx (2pi/1000pix)'</span>, <span class="dt">ylab=</span><span class="st">'ky (2pi/1000pix)'</span>); <span class="kw">points</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dt">cex=</span><span class="dv">5</span>,<span class="dt">col=</span><span class="st">'red'</span>)

<span class="kw">magimage</span>(<span class="kw">profoundPixelCorrelation</span>(im_test_sub, <span class="dt">skyRMS=</span><span class="dv">10</span>, <span class="dt">plot=</span><span class="ot">TRUE</span>)$fft, <span class="dt">xlab=</span><span class="st">'kx (2pi/1000pix)'</span>, <span class="dt">ylab=</span><span class="st">'ky (2pi/1000pix)'</span>); <span class="kw">points</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dt">cex=</span><span class="dv">5</span>,<span class="dt">col=</span><span class="st">'red'</span>)

<span class="kw">magimage</span>(<span class="kw">profoundPixelCorrelation</span>(im_test_fin, <span class="dt">skyRMS=</span><span class="dv">1</span>, <span class="dt">plot=</span><span class="ot">TRUE</span>)$fft, <span class="dt">xlab=</span><span class="st">'kx (2pi/1000pix)'</span>, <span class="dt">ylab=</span><span class="st">'ky (1000/pix)'</span>); <span class="kw">points</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dt">cex=</span><span class="dv">5</span>,<span class="dt">col=</span><span class="st">'red'</span>)

<span class="kw">magimage</span>(<span class="kw">profoundPixelCorrelation</span>(<span class="kw">matrix</span>(<span class="kw">rnorm</span>(<span class="fl">1e6</span>, <span class="dt">mean=</span><span class="dv">0</span>, <span class="dt">sd=</span><span class="dv">10</span>), <span class="dv">1000</span>), <span class="dt">skyRMS=</span><span class="dv">10</span>, <span class="dt">plot=</span><span class="ot">TRUE</span>)$fft, <span class="dt">xlab=</span><span class="st">'kx (2pi/1000pix)'</span>, <span class="dt">ylab=</span><span class="st">'ky (2pi/1000pix)'</span>); <span class="kw">points</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dt">cex=</span><span class="dv">5</span>,<span class="dt">col=</span><span class="st">'red'</span>)</code></pre></div>
<p>The 2D FFT is complex to interpret, and <strong>profoundPixelCorrelation</strong> only returns the power component in the so-called ‘optical representation’, where low k modes are in the centre of the image, and high k modes are in the corners. Slightly counter-intuitively we see power excess in the centre (so low k modes). This is a typical feature of images where the structure is smooth without sharp edges, and in the case of astronomy images will tend to mean we have Gaussian-like structures present in the sky since the Fourier transform of a Guassian is a Gaussian. Since undetected sources will tend to be PSF-like in profile, this will create a visible excess in low k signal in the FFT.</p>
<p>It should be clear that doing a few iterative steps of removing sources and analysing the FFT until there is little low to moderate k-mode signal left is a reasonable route to blindly extracting sources.</p>
<p>In this case we were pushing the data to extremely low surface brightness. We can compare our segmented surface brightness levels to the actual image.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">magplot</span>(<span class="kw">density</span>(finalcat$SB_N100, <span class="dt">na.rm=</span><span class="ot">TRUE</span>), <span class="dt">xlab=</span><span class="st">'Surface Brightness / mag/asec^-2'</span>, <span class="dt">ylab=</span><span class="st">'PDF'</span>)
<span class="kw">abline</span>(<span class="dt">v=</span><span class="kw">mean</span>(pro_test$SBlim), <span class="dt">col=</span><span class="st">'red'</span>)</code></pre></div>
<p>The performance of <strong>ProFound</strong> is obviously substantially better when you are nearer to the nominal surface limit of the image.</p>
<p>Despite running this demo in two phases above, it is in fact hard to do better than a deeper single pass (skycut=1 to skycut=0.9 is the only change here):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pro_test_2=<span class="kw">profoundProFound</span>(im_test, <span class="dt">magzero=</span><span class="dv">30</span>, <span class="dt">skycut=</span><span class="fl">0.9</span>, <span class="dt">pixcut=</span><span class="dv">3</span>, <span class="dt">verbose=</span><span class="ot">TRUE</span>, <span class="dt">plot=</span><span class="ot">TRUE</span>, <span class="dt">boundstats=</span><span class="ot">TRUE</span>, <span class="dt">pixscale=</span><span class="fl">0.34</span>, <span class="dt">tolerance=</span><span class="dv">2</span>)</code></pre></div>
<p>Match back to the intrinsic catalogue as before:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">testmatch_gals_2=<span class="kw">coordmatch</span>(<span class="kw">cbind</span>(model_test$sersic$xcen,model_test$sersic$ycen)/<span class="dv">3600</span>, pro_test_2$segstats[,<span class="kw">c</span>(<span class="st">&quot;xcen&quot;</span>,<span class="st">&quot;ycen&quot;</span>)]/<span class="dv">3600</span>,<span class="dv">5</span>)

testmatch_stars_2=<span class="kw">coordmatch</span>(<span class="kw">cbind</span>(model_test$pointsource$xcen,model_test$pointsource$ycen)/<span class="dv">3600</span>,pro_test_2$segstats[,<span class="kw">c</span>(<span class="st">&quot;xcen&quot;</span>,<span class="st">&quot;ycen&quot;</span>)]/<span class="dv">3600</span>,<span class="dv">5</span>)</code></pre></div>
<p>Galaxy TP = length(testmatch_gals_2<span class="math inline">\(bestmatch[,1])/Ngal Stars TP = length(testmatch_stars_2\)</span>bestmatch[,1])/Nstar Total TP = (length(testmatch_gals_2<span class="math inline">\(bestmatch[,1])+length(testmatch_stars_2\)</span>bestmatch[,1]))/(Ngal+Nstar)</p>
<p>Total FP = (dim(pro_test_2<span class="math inline">\(segstats)[1]-length(testmatch_gals_2\)</span>bestmatch[,1])-length(testmatch_stars_2$bestmatch[,1]))/(Ngal+Nstar)</p>
<p>Running it like this produces similar True-Positive rates, but a lower global False-Positive rate. The moral? If you know what you doing you might want to jump straight to a deeper extraction, but if you are uncertain then you can proceed in a few iterations, i.e. extract the bright sources you are confident about and then go back later to dig around in the noise to get some more.</p>
</div>
<div id="residual-correlation-structure" class="section level2">
<h2>Residual Correlation Structure</h2>
<p>The pixel correlation plots give you some idea of whether there are more sources to be extracted from the data.</p>
<p>First we will re-run <strong>ProFound</strong> with a few different skycut levels:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pro_test_sc1=<span class="kw">profoundProFound</span>(im_test, <span class="dt">magzero=</span><span class="dv">30</span>, <span class="dt">skycut=</span><span class="dv">1</span>, <span class="dt">plot=</span><span class="ot">FALSE</span>, <span class="dt">boundstats=</span><span class="ot">TRUE</span>, <span class="dt">pixscale=</span><span class="fl">0.34</span>, <span class="dt">tolerance=</span><span class="dv">2</span>)
pro_test_sc2=<span class="kw">profoundProFound</span>(im_test, <span class="dt">magzero=</span><span class="dv">30</span>, <span class="dt">skycut=</span><span class="dv">2</span>, <span class="dt">plot=</span><span class="ot">FALSE</span>, <span class="dt">boundstats=</span><span class="ot">TRUE</span>, <span class="dt">pixscale=</span><span class="fl">0.34</span>, <span class="dt">tolerance=</span><span class="dv">2</span>)
pro_test_sc4=<span class="kw">profoundProFound</span>(im_test, <span class="dt">magzero=</span><span class="dv">30</span>, <span class="dt">skycut=</span><span class="dv">4</span>, <span class="dt">plot=</span><span class="ot">FALSE</span>, <span class="dt">boundstats=</span><span class="ot">TRUE</span>, <span class="dt">pixscale=</span><span class="fl">0.34</span>, <span class="dt">tolerance=</span><span class="dv">2</span>)</code></pre></div>
<p>Next we can re make the correlation plots using the</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">profoundPixelCorrelation</span>(im_test, <span class="dt">objects =</span> pro_test_sc1$objects_redo, <span class="dt">sky=</span>pro_test_sc1$sky, <span class="dt">skyRMS=</span>pro_test_sc1$skyRMS, <span class="dt">plot=</span><span class="ot">TRUE</span>, <span class="dt">ylim=</span><span class="kw">c</span>(-<span class="fl">0.1</span>,<span class="fl">0.1</span>))
<span class="kw">profoundPixelCorrelation</span>(im_test, <span class="dt">objects =</span> pro_test_sc2$objects_redo, <span class="dt">sky=</span>pro_test_sc2$sky, <span class="dt">skyRMS=</span>pro_test_sc2$skyRMS, <span class="dt">plot=</span><span class="ot">TRUE</span>, <span class="dt">ylim=</span><span class="kw">c</span>(-<span class="fl">0.1</span>,<span class="fl">0.1</span>))
<span class="kw">profoundPixelCorrelation</span>(im_test, <span class="dt">objects =</span> pro_test_sc4$objects_redo, <span class="dt">sky=</span>pro_test_sc4$sky, <span class="dt">skyRMS=</span>pro_test_sc4$skyRMS, <span class="dt">plot=</span><span class="ot">TRUE</span>, <span class="dt">ylim=</span><span class="kw">c</span>(-<span class="fl">0.1</span>,<span class="fl">0.1</span>))</code></pre></div>
<p>It is worth describing what the above tells us. The solid lines show correlation between all non-masked non-object pixels at different scales. In general an excess correlation means we are on average seeing features at a certain scale. The solid line is actually sensitive to both negative and positive features, where the former could come from a biased sky-subtraction.</p>
<p>To help separate the two the <strong>profoundPixelCorrelation</strong> also returns the difference between the correlation of positive pixels (after sky subtraction) and negative pixels with the same lags (the dashed lines). If the solid line shows an excess and the dashed line is lower (or even on zero) then this is a good clue that the difference is due to a funky sky subtraction or even intrumental correlation structure (particularly true in the NIR), i.e. there is as much positive as negative correlation structure. This means we are probably not missing a significant number of real sources (which are only ever positive). If the dashed line sites above the solid line then it is a sure sign that there are more sources lurking since we see more correlation for positive than negative pixels.</p>
<p>It might be that in a real image the dashed lines can never be brought all the way down to zero, i.e. there are very faint sub-noise objects that are clustered on a typical scale that we can see in these plots, but have no hope of extracting from the image.</p>
</div>
<div id="making-a-better-sky" class="section level2">
<h2>Making a Better Sky</h2>
<p>The <strong>profoundSkySplitFFT</strong> allows us to make a better sky image by extracting residual structure not captured well by out bilinear/bicubic sky maps that use local box cars to estimate the sky.</p>
<p>The basic idea is you provide the original image, your current best effort sky and sky-RMS maps, and your object mask. The function makes an FFT or the image-sky where object pixels are replaced with Normal samples using the appropriate sky and sky-RMS values. If this is done well already then the image created will look like pure noise.</p>
<p>The FFT generated above is then clipped at a user defined scale which separates out low k-mode structure (possible sky) from higher k-mode structure (possible real objects). We can see how much difference this might make using a smoother bicubic sky:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pro_bicubic=<span class="kw">profoundProFound</span>(im_test, <span class="dt">type=</span><span class="st">'bicubic'</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">newsky=<span class="kw">profoundSkySplitFFT</span>(im_test, <span class="dt">objects=</span>pro_bicubic$objects_redo, <span class="dt">sky=</span>pro_bicubic$sky, <span class="dt">skyRMS=</span>pro_bicubic$skyRMS, <span class="dt">skyscale=</span><span class="dv">200</span>)</code></pre></div>
<p>We can see how this compares with the intrinsic and older sky:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">magimage</span>(grid_sky)
<span class="kw">magimage</span>(pro_bicubic$sky)
<span class="kw">magimage</span>(newsky$sky)</code></pre></div>
<p>Not a huge visual difference, but we can see we now have smaller residuals with respect to the intrinsic sky:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">magplot</span>(<span class="kw">density</span>(newsky$sky-grid_sky, <span class="dt">bw=</span><span class="fl">0.1</span>), <span class="dt">col=</span><span class="st">'red'</span>, <span class="dt">grid=</span><span class="ot">TRUE</span>)
<span class="kw">lines</span>(<span class="kw">density</span>(pro_bicubic$sky-grid_sky, <span class="dt">bw=</span><span class="fl">0.1</span>), <span class="dt">col=</span><span class="st">'blue'</span>)
<span class="kw">legend</span>(<span class="st">'topright'</span>, <span class="dt">legend=</span><span class="kw">c</span>(<span class="st">'New - Intrinsic Sky'</span>, <span class="st">'Old - Intrinsic Sky'</span>), <span class="dt">lty=</span><span class="dv">1</span>, <span class="dt">col=</span><span class="kw">c</span>(<span class="st">'red'</span>,<span class="st">'blue'</span>))</code></pre></div>
<p>We can also look at the new high k-mode image to look for sources (effectively im_test-newsky$sky):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">magimage</span>(newsky$sky_hi)</code></pre></div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
