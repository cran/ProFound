<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Aaron Robotham" />

<meta name="date" content="2018-03-02" />

<title>ProFound: Sky Shenanigans</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">ProFound: Sky Shenanigans</h1>
<h4 class="author"><em>Aaron Robotham</em></h4>
<h4 class="date"><em>2018-03-02</em></h4>



<p>Get the latest version of <strong>ProFound</strong> and <strong>ProFit</strong>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(devtools)
<span class="kw">install_github</span>(<span class="st">'asgr/ProFound'</span>)
<span class="kw">install_github</span>(<span class="st">'ICRAR/ProFit'</span>)</code></pre></div>
<p>First load the libraries we need:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ProFound)
<span class="kw">library</span>(ProFit)
<span class="kw">library</span>(LaplacesDemon)</code></pre></div>
<div id="how-the-sky-is-estimated-in-profound" class="section level2">
<h2>How the Sky is Estimated in ProFound</h2>
<p>The sky is estimated mainly via the use of the <strong>profoundMakeSkyMap</strong> function. This basically does the following:</p>
<ol style="list-style-type: decimal">
<li>Divide the image into regions based on the requested box car and grid sampling, by default the grid sampling inherits the box car size, meaning each pixels used in every sampling region are unique and all pixels are used</li>
<li>Each sub region is analysed separately in a large loop:
<ol style="list-style-type: lower-alpha">
<li>The masked pixels are removed from analysis, leaving a vector of fiducial sky pixels (<span class="math inline">\(sky_{fid-pix}\)</span>)</li>
<li>Then the following is computed iteratively (either until the clipping is converged, or after 5 iterations):
<ol style="list-style-type: lower-roman">
<li>The sky value is estimated as <span class="math inline">\(sky=median(sky_{fid-pix})\)</span></li>
<li>The dynamic sigma clip level is estimated to be <span class="math inline">\(\sigma_{clip}=Q_{norm}(1-2/N_{sky})\)</span></li>
<li>The standard deviation of the sky pixels is estimated as <span class="math inline">\(sky_{RMS}=Quantile(sky_{fid-pix},0.5) - Quantile(sky_{fid-pix}, 0.159)\)</span></li>
<li>The plausible sky pixels are dynamically sigma clipped such that pixels satisfying <span class="math inline">\(sky_{fid-pix} &gt; sky + sky_{RMS} \sigma_{clip} \lor sky_{fid-pix} &lt; sky - sky_{RMS} \sigma_{clip}\)</span> are removed</li>
<li>The vector of <span class="math inline">\(sky_{fid-pix}\)</span> is updated and these new fiducial sky pixels are used for the next iteration</li>
</ol></li>
<li>Once convergence has been achieved the final computed <span class="math inline">\(sky\)</span> and <span class="math inline">\(sky_{RMS}\)</span> values are returned for the region under consideration</li>
</ol></li>
<li>With all regions having a unique estimate of the <span class="math inline">\(sky\)</span> and <span class="math inline">\(sky_{RMS}\)</span> a bilinear or bicubic interpolation scheme is used to calculate plausible <span class="math inline">\(sky\)</span> and <span class="math inline">\(sky_{RMS}\)</span> values for all pixels</li>
<li>The <span class="math inline">\(sky\)</span> and <span class="math inline">\(sky_{RMS}\)</span> images are returned to the user or higher level function in a list</li>
</ol>
</div>
<div id="testing-with-toy-data" class="section level2">
<h2>Testing with Toy Data</h2>
<p>We can easily create some toy sky with positive flux added in:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">666</span>)
sky=<span class="kw">c</span>(<span class="kw">rnorm</span>(<span class="fl">5e5</span>,<span class="dt">mean=</span><span class="dv">0</span>,<span class="dt">sd=</span><span class="dv">1</span>),(<span class="kw">rnorm</span>(<span class="fl">5e5</span>,<span class="dt">mean=</span><span class="dv">0</span>,<span class="dt">sd=</span><span class="dv">1</span>)+<span class="kw">runif</span>(<span class="fl">5e5</span>,<span class="dv">0</span>,<span class="dv">100</span>)))
<span class="kw">maghist</span>(sky, <span class="dt">xlab=</span><span class="st">'Pixel Value'</span>, <span class="dt">ylab=</span><span class="st">'Counts'</span>, <span class="dt">grid=</span><span class="ot">TRUE</span>)</code></pre></div>
<p>From the text output of maghist we can see that the raw properties output would make very poor estimates of the sky. To do better we need to clip out non-Normal pixels. Luckily we already have access to a function that does exactly this - magclip.</p>
<p>We can run magclip with the estimate set to both (the default) and lo:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sky_clip_both=<span class="kw">magclip</span>(sky)
sky_clip_lo=<span class="kw">magclip</span>(sky, <span class="dt">estimate=</span><span class="st">'lo'</span>)</code></pre></div>
<p>Since we know the fake sources will have positive flux we would expect estimate=lo to work better:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">magplot</span>(<span class="kw">density</span>(sky_clip_both$x), <span class="dt">col=</span><span class="st">'red'</span>, <span class="dt">grid=</span><span class="ot">TRUE</span>, <span class="dt">xlab=</span><span class="st">'Pixel Value'</span>, <span class="dt">ylab=</span><span class="st">'PDF'</span>)
<span class="kw">lines</span>(<span class="kw">density</span>(sky_clip_lo$x), <span class="dt">col=</span><span class="st">'blue'</span>)</code></pre></div>
<p>Now we can check how good our sky using the lo estimate is, where the black density line is the true sky we want to get back:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">magplot</span>(<span class="kw">density</span>(sky_clip_lo$x), <span class="dt">col=</span><span class="st">'blue'</span>, <span class="dt">grid=</span><span class="ot">TRUE</span>, <span class="dt">xlab=</span><span class="st">'Sky Pixel Value'</span>, <span class="dt">ylab=</span><span class="st">'PDF'</span>)
<span class="kw">lines</span>(<span class="kw">seq</span>(-<span class="dv">5</span>,<span class="dv">5</span>,<span class="dt">len=</span><span class="fl">1e3</span>), <span class="kw">dnorm</span>(<span class="kw">seq</span>(-<span class="dv">5</span>,<span class="dv">5</span>,<span class="dt">len=</span><span class="fl">1e3</span>)), <span class="dt">col=</span><span class="st">'black'</span>, <span class="dt">grid=</span><span class="ot">TRUE</span>)</code></pre></div>
<p>Not bad! The actual sky estimates we end up with are:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">median</span>(sky_clip_lo$x)
<span class="kw">diff</span>(<span class="kw">quantile</span>(sky_clip_lo$x, <span class="kw">pnorm</span>(<span class="kw">c</span>(-<span class="dv">1</span>,<span class="dv">0</span>))))</code></pre></div>
<p>Where ideally we want to answer to be 0 and 1.</p>
<p>We could instead use the mean and standard-deviation, but these tend to be less robust to contamination:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(sky_clip_lo$x)
<span class="kw">sd</span>(sky_clip_lo$x)</code></pre></div>
<p>Both of these estimates are notably higher than using the more robust median and qunatile estimates.</p>
<p>The main ProFound sky estimation routines eventually end up using magclip to do the clipping, in fact they call each other like this:</p>
<pre><code>profoundMakeSkyMap (make a per pixel image)
-profoundMarkSkyGrid (make a coarse sky grid)
--profoundSkyEstLoc (estimate sky and sky_RMS values in a coarse region)
---magclip (dynamically clip pixels within a coarse region)</code></pre>
<p>In practice we also parse <strong>profoundMakeSkyMap</strong> (and all lower functions) a bas pixel mask and/or a binary object mask, so we remove from consideration all of the <em>clearly</em> non-sky pixels before even attempting to do the clipping on what is left.</p>
</div>
<div id="testing-with-more-realistic-data" class="section level2">
<h2>Testing with More Realistic Data</h2>
<p>We can do a more realistic test by using the sky estimate maps from the test VIKING Z-band data we include with <strong>ProFound</strong>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">image=<span class="kw">readFITS</span>(<span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, <span class="st">'VIKING/mystery_VIKING_Z.fits'</span>, <span class="dt">package=</span><span class="st">&quot;ProFound&quot;</span>))
profound=<span class="kw">profoundProFound</span>(image, <span class="dt">skycut=</span><span class="dv">1</span>, <span class="dt">magzero=</span><span class="dv">30</span>, <span class="dt">plot=</span><span class="ot">TRUE</span>)</code></pre></div>
<p>From this we get a reasonable sky and sky-RMS map:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">magimage</span>(profound$sky)
<span class="kw">magimage</span>(profound$skyRMS)

<span class="kw">maghist</span>(profound$sky, <span class="dt">xlab=</span><span class="st">'Pixel Value'</span>, <span class="dt">ylab=</span><span class="st">'Counts'</span>, <span class="dt">grid=</span><span class="ot">TRUE</span>)
<span class="kw">maghist</span>(profound$skyRMS, <span class="dt">xlab=</span><span class="st">'Pixel Value'</span>, <span class="dt">ylab=</span><span class="st">'Counts'</span>, <span class="dt">grid=</span><span class="ot">TRUE</span>)</code></pre></div>
<p>You can see in the sky-RMS histograms that there are two distinct depths in the test data. This is due to data being stacked to make the final image.</p>
<p>We can now make a noise free simulated image with a mixture of stars and galaxies (the extraction found 67 sources, and we use <strong>ProFound</strong> properties where appropriate):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">ExamplePSF=<span class="kw">profitMakeGaussianPSF</span>(<span class="dt">fwhm=</span><span class="dv">5</span>)
ExamplePSF=ExamplePSF/<span class="kw">sum</span>(ExamplePSF)

model_test=<span class="kw">list</span>(
    <span class="dt">sersic=</span><span class="kw">list</span>(
        <span class="dt">xcen=</span><span class="kw">runif</span>(<span class="dv">67</span>,<span class="dv">0</span>,<span class="dv">356</span>),
        <span class="dt">ycen=</span><span class="kw">runif</span>(<span class="dv">67</span>,<span class="dv">0</span>,<span class="dv">356</span>),
        <span class="dt">mag=</span>profound$segstats$mag,
        <span class="dt">re=</span>profound$segstats$R50,
        <span class="dt">nser=</span><span class="kw">runif</span>(<span class="dv">67</span>,<span class="fl">0.5</span>,<span class="dv">4</span>),
        <span class="dt">ang=</span><span class="kw">runif</span>(<span class="dv">67</span>,<span class="dv">0</span>,<span class="dv">180</span>),
        <span class="dt">axrat=</span><span class="kw">runif</span>(<span class="dv">67</span>,<span class="fl">0.3</span>,<span class="dv">1</span>),
        <span class="dt">box=</span><span class="kw">rep</span>(<span class="dv">0</span>,<span class="dv">67</span>)
    )
)

im_test&lt;-<span class="kw">profitMakeModel</span>(<span class="dt">modellist=</span>model_test, <span class="dt">psf=</span>ExamplePSF, <span class="dt">dim=</span><span class="kw">c</span>(<span class="dv">356</span>,<span class="dv">356</span>), <span class="dt">magzero =</span> <span class="dv">30</span>)$z</code></pre></div>
<p>Let’s take a look:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">magimage</span>(im_test)</code></pre></div>
<p>We can now add back in the sky and sky-RMS we just calculated:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">im_test_noise=im_test+<span class="kw">rnorm</span>(<span class="dv">356</span>^<span class="dv">2</span>, <span class="dt">mean=</span>profound$sky, <span class="dt">sd=</span>profound$skyRMS)</code></pre></div>
<p>Let’s take a look:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">magimage</span>(im_test_noise)</code></pre></div>
<p>We can now run <strong>ProFound</strong> on this simualted data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">profound_resim=<span class="kw">profoundProFound</span>(im_test_noise, <span class="dt">skycut=</span><span class="dv">1</span>, <span class="dt">magzero=</span><span class="dv">30</span>, <span class="dt">plot=</span><span class="ot">TRUE</span>)</code></pre></div>
<p>So finally we can check our new sky estimates:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">magimage</span>(profound$sky)
<span class="kw">magimage</span>(profound$skyRMS)

<span class="kw">magimage</span>(profound_resim$sky)
<span class="kw">magimage</span>(profound_resim$skyRMS)

<span class="kw">magimage</span>(profound$sky-profound_resim$sky)
<span class="kw">magimage</span>(profound$skyRMS-profound_resim$skyRMS)</code></pre></div>
<p>It is perhaps more useful to look at the histograms directly:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">maghist</span>(profound$sky, <span class="dt">xlab=</span><span class="st">'Pixel Value'</span>, <span class="dt">ylab=</span><span class="st">'Counts'</span>, <span class="dt">grid=</span><span class="ot">TRUE</span>)
<span class="kw">maghist</span>(profound$skyRMS, <span class="dt">xlab=</span><span class="st">'Pixel Value'</span>, <span class="dt">ylab=</span><span class="st">'Counts'</span>, <span class="dt">grid=</span><span class="ot">TRUE</span>)

<span class="kw">maghist</span>(profound_resim$sky, <span class="dt">xlab=</span><span class="st">'Pixel Value'</span>, <span class="dt">ylab=</span><span class="st">'Counts'</span>, <span class="dt">grid=</span><span class="ot">TRUE</span>)
<span class="kw">maghist</span>(profound_resim$skyRMS, <span class="dt">xlab=</span><span class="st">'Pixel Value'</span>, <span class="dt">ylab=</span><span class="st">'Counts'</span>, <span class="dt">grid=</span><span class="ot">TRUE</span>)

<span class="kw">maghist</span>(profound$sky-profound_resim$sky, <span class="dt">xlab=</span><span class="st">'Pixel Value'</span>, <span class="dt">ylab=</span><span class="st">'Counts'</span>, <span class="dt">grid=</span><span class="ot">TRUE</span>)
<span class="kw">maghist</span>(profound$skyRMS-profound_resim$skyRMS, <span class="dt">xlab=</span><span class="st">'Pixel Value'</span>, <span class="dt">ylab=</span><span class="st">'Counts'</span>, <span class="dt">grid=</span><span class="ot">TRUE</span>)</code></pre></div>
<p>Broadly we can see many of the sky features are being found in the same places on the image.</p>
<p>The simplest metric to decide whether we are, on average, doing the right thing is to compare the standard deviation in the input sky to that obtained from the input-estimated sky:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sd</span>(profound$sky)
<span class="kw">sd</span>(profound$sky-profound_resim$sky)

<span class="kw">sd</span>(profound$skyRMS)
<span class="kw">sd</span>(profound$skyRMS-profound_resim$skyRMS)</code></pre></div>
<p>We can see there is a large reduction in the absolute sky variance, and a small reduction in the sky-RMS variance. The take-home here is that <strong>ProFound</strong> is at least bringing the sky and sky-RMS closer to the intrinsic values (i.e. better than doing nothing or using a fixed estimator), but it is not perfect.</p>
</div>
<div id="bias-as-a-function-of-number-of-sky-vs.object-pixels" class="section level2">
<h2>Bias as a Function of Number of Sky vs. Object pixels</h2>
<p>A good question is how contaminated the sky pixels can be (i.e. non-masked and non-object pixels) for us to still get a decent estimate of the true sky.</p>
<p>We can do this experiment roughly by varying the number of pixels with object flux in our toy sky model from earlier:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">contam=<span class="kw">seq</span>(<span class="fl">1e5</span>, <span class="fl">2e6</span>, <span class="dt">by=</span><span class="fl">1e5</span>)
N=<span class="kw">length</span>(contam)
output=<span class="kw">cbind</span>(contam,<span class="kw">rep</span>(<span class="dv">0</span>,N), <span class="kw">rep</span>(<span class="dv">0</span>,N), <span class="kw">rep</span>(<span class="dv">0</span>,N), <span class="kw">rep</span>(<span class="dv">0</span>,N))
for(i in <span class="dv">1</span>:N){
  sky=<span class="kw">c</span>(<span class="kw">rnorm</span>(<span class="fl">5e5</span>,<span class="dt">mean=</span><span class="dv">0</span>,<span class="dt">sd=</span><span class="dv">1</span>),(<span class="kw">rnorm</span>(contam[i],<span class="dt">mean=</span><span class="dv">0</span>,<span class="dt">sd=</span><span class="dv">1</span>)+<span class="kw">runif</span>(contam[i],<span class="dv">0</span>,<span class="dv">100</span>)))
  sky_clip_lo=<span class="kw">magclip</span>(sky, <span class="dt">estimate=</span><span class="st">'lo'</span>)
  output[i,<span class="dv">2</span>]=<span class="kw">as.numeric</span>(<span class="kw">median</span>(sky_clip_lo$x))
  output[i,<span class="dv">3</span>]=<span class="kw">as.numeric</span>(<span class="kw">diff</span>(<span class="kw">quantile</span>(sky_clip_lo$x, <span class="kw">pnorm</span>(<span class="kw">c</span>(-<span class="dv">1</span>,<span class="dv">0</span>)))))
  output[i,<span class="dv">4</span>]=<span class="kw">as.numeric</span>(<span class="kw">mean</span>(sky_clip_lo$x))
  output[i,<span class="dv">5</span>]=<span class="kw">as.numeric</span>(<span class="kw">sd</span>(sky_clip_lo$x))
}</code></pre></div>
<p>We can plot how this behaves:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">magplot</span>(<span class="dv">1</span>-output[,<span class="dv">1</span>]/(<span class="fl">5e5</span>+output[,<span class="dv">1</span>]),output[,<span class="dv">2</span>], <span class="dt">log=</span><span class="st">'y'</span>, <span class="dt">grid=</span><span class="ot">TRUE</span>, <span class="dt">xlab=</span><span class="st">'Nsky/Ntotal'</span>, <span class="dt">ylab=</span><span class="st">'(Sky Estimate) - (Sky Input)'</span>, <span class="dt">type=</span><span class="st">'l'</span>, <span class="dt">col=</span><span class="st">'red'</span>)
<span class="kw">lines</span>(<span class="dv">1</span>-output[,<span class="dv">1</span>]/(<span class="fl">5e5</span>+output[,<span class="dv">1</span>]),output[,<span class="dv">4</span>], <span class="dt">col=</span><span class="st">'blue'</span>)
<span class="kw">legend</span>(<span class="st">'topright'</span>, <span class="dt">legend=</span><span class="kw">c</span>(<span class="st">'Median'</span>,<span class="st">'Mean'</span>), <span class="dt">lty=</span><span class="dv">1</span>, <span class="dt">col=</span><span class="kw">c</span>(<span class="st">'red'</span>,<span class="st">'blue'</span>))

<span class="kw">magplot</span>(<span class="dv">1</span>-output[,<span class="dv">1</span>]/(<span class="fl">5e5</span>+output[,<span class="dv">1</span>]),output[,<span class="dv">3</span>]-<span class="dv">1</span>, <span class="dt">log=</span><span class="st">'y'</span>, <span class="dt">grid=</span><span class="ot">TRUE</span>, <span class="dt">xlab=</span><span class="st">'Nsky/Ntotal'</span>, <span class="dt">ylab=</span><span class="st">'(Sky-RMS Estimate) - (Sky-RMS Input)'</span>, <span class="dt">type=</span><span class="st">'l'</span>, <span class="dt">col=</span><span class="st">'red'</span>)
<span class="kw">lines</span>(<span class="dv">1</span>-output[,<span class="dv">1</span>]/(<span class="fl">5e5</span>+output[,<span class="dv">1</span>]),output[,<span class="dv">5</span>]-<span class="dv">1</span>, <span class="dt">col=</span><span class="st">'blue'</span>)
<span class="kw">legend</span>(<span class="st">'topright'</span>, <span class="dt">legend=</span><span class="kw">c</span>(<span class="st">'Quantile Range'</span>,<span class="st">'Standard-Deviation'</span>), <span class="dt">lty=</span><span class="dv">1</span>, <span class="dt">col=</span><span class="kw">c</span>(<span class="st">'red'</span>,<span class="st">'blue'</span>))</code></pre></div>
<p>We can see that both the sky and sky-RMS estimates behave best when the contamination level is small (i.e. they are pretty unbiased when the sky to object ration is 5:1). From this point they become gradually more biased (always positively), and then they fail spectacularly when the sky to object ration is 5:8 or above (i.e. less than 40% of pixels are sky pixels).</p>
<p>The example above is only for a simple toy model, but it gives you some idea that you want comfortably more than half of the pixels to be real sky pixels in general. Obviously using the bad pixel mask and the objects mask helps a lot, but in detail very few pixels are pure sky pixels because there are always increasingly faint (sub surface brightness limit) sources that bias the flux positively and in a non-uniform manner. This is similar to saying that all images are <em>confused</em>, you just cannot always tell by looking at them. This fact is more obvious when you consider the earlier simulated image data before and after we add realistic sky noise. Those broad low-surface brightness wings are still there in the noisy image, they are just well below the applied noise level. However, those low surface brightness features are still able to bias our estimated sky away from the intrinsic values we would like to know.</p>
<p>The difference between the sky level estimators (mean, median or mode) and sky-RMS level estimator (quantile vs. standard-deviation) is an interesting point to consider. In the toy situation described it is easy to convince yourself that you would want to use the median for the sky and the quantile for the sky-RMS, since these are both systematically nearer to the specified ‘intrinsic’ sky. However, what really matters is the origin of the positively biased flux that skews the distribution. There are a number of processes that generate the ‘sky’ and contribute to the extended area signal in a typical CCD image, in roughly descending order of importance:</p>
<ol style="list-style-type: decimal">
<li>The actual night sky caused by Earth’s atmosphere glowing. Can be quite spatially and temporally variable (in the NIR, distant artificial lights turning on and off etc)</li>
<li>Flux scattered around the image due to telescope optics causing very broad ~Lorentzian wings</li>
<li>Scattering of astronomical light by the Earth’s atmosphere, usually at very small scales (close to Gaussian usually)</li>
<li>Intrinsically broad features caused by the Milky-Way foreground</li>
<li>Intrinsically broad wings caused by extra-galactic sources (low surface brightness wings of galaxies)</li>
<li>Undetectable faint sources, can be structured (Milky-Way stars) or effectively uniform in distribution (high redshift galaxies)</li>
</ol>
<p>The question is then: which of these do you want to remove? The answer clearly depends on what sources you are trying to extract photometry for. If you are doing stellar photometry of a bright star then you almost certainly want to remove 1/4/5/6, i.e. you actually want to model the light from the star that has been scattered by the atmosphere and the telescope (assuming it is the dominant contribution close to the star being modelled). If you want to profile a faint galaxy then you probably need to remove 1/2 (assuming it mostly caused by other source)/3 (assuming it mostly caused by other source)/4/6, i.e. you want to keep the faint wings of your target galaxy intact. There is not a trivially right answer, but <strong>ProFound</strong> does offer a few routes to compute these different types of sky. The basic message is you might prefer a median type sky or a mean type sky, depending on your use case. If your source sits <strong>on top of</strong> the sky (whatever makes it) then you probably want to use the more biased mean estimator. If your source <strong>is the dominant part</strong> of the observable background (e.g. when profiling the faint wings of galaxies) then you might prefer the less biased median estimator.</p>
<p>An unresolved issue is whether you can extract better models by using <strong>ProFit</strong> to model the background for a given source. The three obvious options are:</p>
<ul>
<li>Use <strong>ProFound</strong> sky subtraction on the image and do not fit a sky background in <strong>ProFit</strong></li>
<li>Use <strong>ProFound</strong> sky subtraction on the image and also fit a sky background in <strong>ProFit</strong></li>
<li>Do not use the <strong>ProFound</strong> sky subtraction on the image and only fit a sky background in <strong>ProFit</strong></li>
</ul>
<p>For pragmatic reasons of needing to remove complex sky that cannot be fully generatively modelled with , options 1 or 2 are likely to be the best strategy with the majority of use cases.</p>
</div>
<div id="profound-sky-options" class="section level2">
<h2>ProFound Sky Options</h2>
<p>Below we will run the ProFound sky routine with and without sky clipping and using the three different estimators (mean, median, mode):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">profound_median_clip=<span class="kw">profoundProFound</span>(image, <span class="dt">skycut=</span><span class="fl">1.0</span>, <span class="dt">magzero=</span><span class="dv">30</span>, <span class="dt">skytype=</span><span class="st">'median'</span>, <span class="dt">doclip=</span><span class="ot">TRUE</span>) <span class="co">#The default mode</span>
profound_median_noclip=<span class="kw">profoundProFound</span>(image, <span class="dt">skycut=</span><span class="fl">1.0</span>, <span class="dt">magzero=</span><span class="dv">30</span>, <span class="dt">skytype=</span><span class="st">'median'</span>, <span class="dt">doclip=</span><span class="ot">FALSE</span>)
profound_mean_clip=<span class="kw">profoundProFound</span>(image, <span class="dt">skycut=</span><span class="fl">1.0</span>, <span class="dt">magzero=</span><span class="dv">30</span>, <span class="dt">skytype=</span><span class="st">'mean'</span>, <span class="dt">doclip=</span><span class="ot">TRUE</span>)
profound_mean_noclip=<span class="kw">profoundProFound</span>(image, <span class="dt">skycut=</span><span class="fl">1.0</span>, <span class="dt">magzero=</span><span class="dv">30</span>, <span class="dt">skytype=</span><span class="st">'mean'</span>, <span class="dt">doclip=</span><span class="ot">FALSE</span>)
profound_mode_clip=<span class="kw">profoundProFound</span>(image, <span class="dt">skycut=</span><span class="fl">1.0</span>, <span class="dt">magzero=</span><span class="dv">30</span>, <span class="dt">skytype=</span><span class="st">'mode'</span>, <span class="dt">doclip=</span><span class="ot">TRUE</span>)
profound_mode_noclip=<span class="kw">profoundProFound</span>(image, <span class="dt">skycut=</span><span class="fl">1.0</span>, <span class="dt">magzero=</span><span class="dv">30</span>, <span class="dt">skytype=</span><span class="st">'mode'</span>, <span class="dt">doclip=</span><span class="ot">FALSE</span>)</code></pre></div>
<p>The difference between the clipped and non-clipped runs are tiny (meaning we have found pretty much all of the sources):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">maghist</span>(profound_median_clip$sky-profound_median_noclip$sky, <span class="dt">grid=</span><span class="ot">TRUE</span>)
<span class="kw">maghist</span>(profound_mean_clip$sky-profound_mean_noclip$sky, <span class="dt">grid=</span><span class="ot">TRUE</span>)
<span class="kw">maghist</span>(profound_mode_clip$sky-profound_mode_noclip$sky, <span class="dt">grid=</span><span class="ot">TRUE</span>)</code></pre></div>
<p>The differences between the different estimators are larger:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">maghist</span>(profound_mean_clip$sky-profound_median_clip$sky, <span class="dt">grid=</span><span class="ot">TRUE</span>)
<span class="kw">maghist</span>(profound_mode_clip$sky-profound_median_clip$sky, <span class="dt">grid=</span><span class="ot">TRUE</span>)
<span class="kw">maghist</span>(profound_mean_clip$sky-profound_mode_clip$sky, <span class="dt">grid=</span><span class="ot">TRUE</span>)</code></pre></div>
<p>The median and the mode are the most similar, and for most people the choice will come down to using one of these two. We can check the impact this choice might have on the photometry:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">magplot</span>(profound_median_clip$segstats$mag, profound_median_clip$segstats$mag-profound_mean_clip$segstats$mag, <span class="dt">ylim=</span><span class="kw">c</span>(-<span class="fl">0.1</span>,<span class="fl">0.1</span>), <span class="dt">xlab=</span><span class="st">'Median mag'</span>, <span class="dt">ylab=</span><span class="st">'(Median mag) - (Mean mag)'</span>, <span class="dt">grid=</span><span class="ot">TRUE</span>)
<span class="kw">lines</span>(<span class="kw">magrun</span>(profound_median_clip$segstats$mag, profound_median_clip$segstats$mag-profound_mean_clip$segstats$mag), <span class="dt">col=</span><span class="st">'red'</span>)</code></pre></div>
<p>So even down to our detection limit the difference tends to be a few hundredths of a mag on average, with the average effect that subtracting a median sky leaves more flux in the image (on average) given us brighter measured magnitudes. For this reason it is probably a good check to always run <strong>ProFound</strong> with both types of sky and check there are not regions with pathelogically weird differences.</p>
</div>
<div id="improving-our-sky-map-with-ffts" class="section level2">
<h2>Improving Our Sky Map with FFTs</h2>
<p>By doing ProFound source detection on the FFT itself it tells us if there are significant sources of a certain common scale (usually small) still in the image to extract. We can improve the sky using <strong>profoundSkySplitFFT</strong>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">profound=<span class="kw">profoundProFound</span>(image, <span class="dt">type=</span><span class="st">&quot;bicubic&quot;</span>)
newsky=<span class="kw">profoundSkySplitFFT</span>(image$imDat, <span class="dt">objects=</span>profound$objects_redo, <span class="dt">sky=</span>profound$sky, <span class="dt">skyRMS=</span>profound$skyRMS)</code></pre></div>
<p>We can check the old versus new sky:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">magimage</span>(profound$sky)
<span class="kw">magimage</span>(newsky$sky)</code></pre></div>
<p>We can have a look at the original image, old sky subtraction and new sky subtraction (pretty subtle!):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">magimage</span>(image$imDat)
<span class="kw">magimage</span>(image$imDat-profound$sky)
<span class="kw">magimage</span>(image$imDat-newsky$sky)</code></pre></div>
<p>Be warned, you need a reasonable estimate of the sky and objects before running <strong>profoundSkySplitFFT</strong>.</p>
<p>If we run on the original image that even the high/low k modes look very odd:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">magimage</span>(<span class="kw">profoundSkySplitFFT</span>(image$imDat)$sky_lo)
<span class="kw">magimage</span>(<span class="kw">profoundSkySplitFFT</span>(image$imDat)$sky_hi)</code></pre></div>
</div>
<div id="doing-better" class="section level2">
<h2>Doing Better</h2>
<p>I (ASGR) spent a bit of time looking at whether you can do better by attempting to fit a true generative model to the sky. Even when the model is exactly the type used to generate the sky (which will not true for real data of course, the toy setup here is only crudely realistic) there is such a degeneracy between betweent the sky level and the mode of the Normal sky / start of the uniform object distribution, that you rarely do better than the clipped estimate used in ProFound currently. By using medians and quantiles we are also more robust to Lorentzian wings of weirdness, bright star artefacts, and cosmic ray effects (which can even created negative signals depending on how the sky pedestal is implemented).</p>
<p>All this said, I am all ears as to how we might be able to estimate the sky better. Any estimator must be pragmatic (be able to cope with the fact that real data is not perfect, not in detail Normal, etc), so I hope you can appreciate that this is not a trivial task.</p>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
